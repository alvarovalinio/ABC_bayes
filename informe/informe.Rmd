---
title: "Estudio de las Tasas específicas de fecundidad mediante técnicas ABC"
subtitle: "Taller de modelos computacionales con aplicaciones en demografía"
author: "Alvaro Valiño - Lucia Coudet"
date: "Abril de 2021"
output: pdf_document
documentclass: article
fontsize: 10pt
header-includes:
  \usepackage{float}
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, message = FALSE, warning = FALSE, comment = FALSE)
library(magrittr)
library(data.table)
library(tidyverse)
library(here)
library(xtable)
library(knitr)

source(here("script_aux", "funcion_int_post.R"))
```


```{r fig.align='center',echo=FALSE} 
include_graphics("Udelar.png") 
```

\newpage

# Resumen ejecutivo

En este trabajo se presenta un estudio de la incertidumbre en la predicción de un modelo demográfico que simula las tasas específicas de fecundidad por edad (\textit{ASFR}) para una población en la cual no existe control sobre los nacimientos.
\\
El modelo se estima mediante técnicas de Computación Bayesiana Aproximada (\textit{ABC}) sobre datos de una comunidad religiosa conocida por su rechazo de los métodos anticonceptivos. En particular, se considera el efecto de la tolerancia utilizada para aceptar valores de los parámetros en la incertidumbre resultante en la estimación. 

Para ello, se realizó primero una estimación puntual considerada óptima como aquella que minimiza el Error Cuadrático Medio (\textit{ECM}) y luego se construyeron diferentes intervalos de credibilidad. Si bien todos se encuentran construidos al 95\% de credibilidad, la incertidumbre varía notablemente en función de los niveles de tolerancia considerados. 

Como principal resultado es posible mencionar que se observó una relación positiva entre el nivel de incertidumbre y el incremento en la tolerancia del algoritmo. Por último, se presentan pasos a seguir para futuras investigaciones.

# Introducción

El objetivo de éste trabajo es representar la incertidumbre en la estimación de las
tasas específicas de fecundidad por edad (\textit{ASFR}) provenientes de una población en la que no existe control sobre los nacimientos. Es decir, en régimen de fecundidad natural. 
Para ello, se considera la incertidumbre sobre los parámetros que controlan el
descenso en el riesgo de concebir con la edad: $\alpha$ y $\kappa$.

\begin{itemize}
\item $\alpha$ edad en la que decae la fecundidad
\item $\kappa$ tasa para dicho $\alpha$
\end{itemize}

Con el fin de lograr la reproducibilidad de los resultados obtenidos, se consideró
apropiado utilizar un repositorio remoto público. \footnote{\url{https://github.com/alvarovalinio/ABC_bayes}}.

Se destaca que los resultados obtenidos fueron a través del lenguaje y entorno
de programación para análisis estadístico y gráfico, R.

# Marco metodológico

En primer lugar, las tasas específicas de fecundidad se definen como:

$$_nF_x[0,T] = \frac{_nB_x[0,T]}{_nL_x[0,T]}$$

Dónde 
\begin{itemize}
\item $_nB_x[0,T]$ es la cantidad de nacimientos de mujeres entre las edades x y x+n en el periodo de tiempo 0 a T.
\item $_nL_x[0,T]$ es la cantidad de mujeres entre el periodo de tiempo 0 a T. 
\end{itemize}

Con el fin de modelar las \textit{ASFR}, se utilizó el modelo \textit{Comfert}, un modelo computacional a nivel micro, que representa las trayectorias reproductivas de una cohorte de mujeres en un contexto de fecunidad "natural", es decir, en ausencia de control de los nacimientos.

Es importante destacar que uno de los supuestos base del modelo es que las mujeres están expuestas al riesgo de concebir inmediatamente después del inicio de una unión con cohabitación. De esta forma, la formación de la unión marca el inicio del proceso reproductivo. El tiempo de espera a este evento se modela de la siguiente manera: 
$$ln(U) \sim N(\mu, \sigma)$$

El modelo también considera la heterogeneidad con respecto a la capacidad de concebir tanto entre mujeres como a través de tiempo. Éste último, incorporando al análisis el declive en la capacidad biológica de concebir debido al efecto del paso del tiempo. La heterogeneidad en la tasa de fecundidad se modela entonces como: 
$$\phi \sim \Gamma(shape, rate)$$
A su vez, como se mencionó anteriormente, se asume un régimen de fecundidad natural, el cual implica la no utilización de ningún tipo de métodos anticonceptivos. Por otra parte, el modelo \textit{Comfert} incluye periodos de no suceptibilidad de la madre luego del nacimiento.

De este forma, los componentes principales del modelo son:

\begin{enumerate}
\item Inicio $ln(U) \sim N(\mu, \sigma)$, 
\item Heterogeneidad de la Tasa de fecundidad $\phi \sim \Gamma(shape, rate) \rightarrow h(x, \alpha, \kappa) = \frac{1}{1+e\lbrace{-\kappa*(x-\alpha) \rbrace}}$ y 
\item Periodo de no-suceptibilidad
\end{enumerate}

Sin embargo, a la hora de estimar los parámetros y debido a la incapacidad de estimar la función de verosimilitud, se procedió a trabajar con métodos de estimación que no dependen de dicha función  (\textit{Likelihood free}). En particular desde un enfoque bayesiano, utilizando la Computación bayesiana aproximada (\textit{ABC}).

A continuación se presenta una breve descripción del algoritmo \textit{ABC}:

Sean: 1) $y_0$ un dato observado, 2) $p(\theta)$ distribución a priori, 3) $p(y|\theta)$ la función de verosimilitud de $y|\theta$, 4) una medida de discrepancia ($\Delta$), y 5) un valor de tolerancia $\epsilon$. 

Algoritmo:

\begin{enumerate}
\item Obtener $\theta^*$ de $P(\theta)$
\item Simular $P(y|\theta*)$ 
   
   if $y_{sim} = y_0$ (discrete data) $\Delta (\eta_0, \eta_{sim})$ $<$ $\epsilon$ (continuos data) 
   
   $\rightarrow$ $\theta^*$ forma parte de la posterior;
   
   else 
   
   descartamos $\theta^*$ 

\item Repetir 1 y 2 hasta que se tenga un número suficiente de valores para $\theta$.    
\end{enumerate}
 
Debido al elevado costo computacional que implica obtener estimaciones a partir del modelo \textit{Comfert}, se procedió a trabajar con una versión adaptada del algoritmo \textit{ABC}.

Para ello, se ajusta un meta modelo (en particular un proceso gaussiano) que es utilizado como sustituto del modelo \textit{Comfert}. A su vez, con el fin de optimizar la búsqueda de combinaciones de parámetros pero sin condicionar sustantivamente los resultados (zonas sin explorar) se procedió a utilizar la función denominada \textit{acquisition function}. 

De esta manera, los puntos pertenecientes al subconjunto del espacio paramétrico obtenido son evaluados como posibles candidatos de la distribución a posteriori $p(\theta|y)$.

Una vez seleccionados los candidatos, se procedió a estimar la densidad de la predictiva posterior ($p(\tilde{y}|y)$), obteniendo así para cada edad, estimaciones de la distribución de probabilidad a posteriori de la \textit{ASFR}.

Como estimación puntual se toma la estimación resultante de elegir el conjunto de parámetros que minimiza el error cuadrático medio (\textit{ECM}):

$$\text{ECM} = \frac{\sum_{i=1}^n (y_s -y_{obs})^2}{n}$$

Dónde: 
\begin{itemize}
\item $y_s$ son los valores simulados de las \textit{ASFR} para cada edad, utilizando la metodología \textit{ABC} (\textit{Comfert abc}).
\item $y_{obs}$ son los valores de la \textit{ASFR} para cada edad observados en la población.
\item $n$ son la cantidad de edades consideradas.
\end{itemize}

Por otro lado, con el fin de medir la incertidumbre en la estimación de las \textit{ASFR} se calculan los intervalos de credibilidad al 95\% de la predictiva posterior. 

# Resultados

A continuación se presentan gráficamente la evolución de las \textit{ASFR} observadas en función de la edad:


```{r}
obs <- readr::read_csv(here::here("Materiales/datos","asfr_hutterites.csv"))
```

```{r, fig.cap = 'Gráfico de líneas de las tasas de fecundidad por edad en la población', out.width='80%', fig.align='center', warning=FALSE, message=FALSE, comment=FALSE, fig.pos="H"}
ggplot(obs) + geom_point(aes(x = age, y = fx), color = 'grey41') +
      geom_line(aes(x = age, y = fx), color = 'grey41') +
      theme(axis.title = element_text(face = 'bold')) +
      labs(x = 'Edad', y = 'fx (ASFR)') 
```

Por otra parte, en la figura 2 se presenta el gráfico de la estimación puntual para cada \textit{ASFR} según el criterio del \textit{ECM} definido en la sección marco metodológico. 

```{r}
ini_c <- 2000
n0 <- 100 
ne <- 10
N <- 520 


res_dir <- file.path("Materiales/resultados", paste0("ini_c_", ini_c), paste0("ne_", ne), paste0("N_", N))
post_candidates <- readr::read_rds(here::here("Materiales/resultados/ini_c_2000/ne_10/N_520/evals", "evalued_points.rds"))

# Optimal combination of parameters
min_mse <- post_candidates %>% as_tibble() %$% min(.$mse)

#busca el indice donde se da el minimo
paramset <- which(post_candidates$mse == min_mse)[1] # results dir for min mse
opt_res_dir <- file.path(res_dir, paste0("param_set_", n0+paramset))


#lee las simulaciones obtenidas con las combinaciones de kappa y alpha que minimizan el error
#SON LOS VALORES SIMULADOS DE LA ASFR CON KAPPA Y ALPHA OPTIMOS (QUE MINIMIZAN EL MSE)
sim <- readr::read_rds(here(file.path(opt_res_dir), "fx.RData"))
sim <- as_tibble(sim)

# plot obs vs. sim de combinacion con menor distancia
sim <- sim %>% mutate(tipo = 'simulado') 
obs <- obs %>% mutate(tipo = 'observado')
data <- sim %>% bind_rows(obs)

```



```{r, fig.cap = 'Gráfico de líneas de las tasas de fecundidad por edad observada en la población y estimaciones según el criterio del mínimo ECM. Se observa que el modelo subestima las ASFR para edad tempranas (entre 10 y 20 años de edad). Por otro lado, el modelo tiende a sobrestimar para las edades entre 20 y 35 aproximadamente.',fig.pos="H"}

ggplot(data) + 
      geom_line(aes(x = age, y = fx, colour = tipo))  +
      geom_point(aes(x = age, y = fx, colour = tipo)) +
      theme(axis.title = element_text(face = 'bold',size = '12'),
            plot.title = element_text(face = 'bold', size = 14, hjust = 0.5),
            plot.subtitle = element_text(hjust = 0.5),
            legend.position = 'bottom',
            legend.title = element_text(face = 'bold'),
            legend.background = element_rect(linetype = 1, size = 0.5, color = 1)) +
      labs(x = 'Edad', y = 'ASFR fx') +
      scale_color_manual(values = c('grey41', 'orangered'), name = 'Datos')
```

No obstante, es importante destacar que el gráfico de la figura 2 fue construido a partir de una sola realización del proceso. Por lo tanto, no permite visualizar la aleatoriedad en las \textit{ASFR}.

Con el fin de obtener una primera noción de dicha aleatoriedad, se presenta en la figura 3 el gráfico de las estimaciones de las \textit{ASFR} por edad utilizando valores de $\alpha$ y $\kappa$ seleccionados al azar:

```{r epsilon}
edad2 <- 10:55 %>% data.table()
colnames(edad2) <- "age"

# Agregamos id para mapear
post_candidates2 <- post_candidates
post_candidates2$id <- 1:nrow(post_candidates2)

# definir distancia - valor que comprende el 10% de las combinaciones con menor distancia
epsilon <- quantile(post_candidates2$mse,probs = seq(0, 1, 0.10))[2]
accepted <- post_candidates2[post_candidates2$mse < epsilon,] 


# Loop para cargar datos de carpetas

for (i in 1:nrow(accepted)){
  ruta <- paste0("Materiales/resultados/ini_c_2000/ne_10/N_520/param_set_",accepted$id[i]+100) 
  y_pred <- read_rds(here(ruta,'fx.Rdata')) %>% data.table()
  colnames(y_pred) <- c("age",paste0("fx_",i+100))
  setkey(y_pred,age)
  setkey(edad2,age)
  edad2 <- edad2[y_pred,nomatch=0]
}

quantiles2 <- apply(edad2[,-1],1,function(y){
  int_inf <- quantile(y,0.025)
  int_sup <- quantile(y,0.975)
  mediana <- quantile(y,0.5)
  return(c(int_inf,int_sup,mediana))
}) 

datos2 <- data.table(age=edad2$age,int_inf=quantiles2[1,],int_sup=quantiles2[2,],mediana=quantiles2[3,])
# Agregamos los valores del simulado
datos2$fx <- obs$fx

datos3 <- int_post(11)
datos4 <- int_post(16)
```


```{r}
#gráfico
#seleccionando 4 - 6 indices al azar de la grilla de alphas y kappas
set.seed(543210)
aleat <- edad2 %>% select(c(1,sample(2:ncol(edad2),4)))
```



```{r, fig.cap = 'Gráfico de líneas de las tasas de fecundidad por edad observada en la población y estimaciones para valores del ECM seleccionados aleatoriamente.', fig.pos="H"}

aleat %>% pivot_longer(-age, names_to = 'index') %>% ggplot() + 
      geom_line(aes(x = age, y = value, colour = index))  +
      geom_point(aes(x = age, y = value, colour = index)) +
      theme(axis.title = element_text(face = 'bold',size = '12'),
            plot.title = element_text(face = 'bold', size = 14, hjust = 0.5),
            plot.subtitle = element_text(hjust = 0.5),
            legend.position = 'bottom',
            legend.title = element_text(face = 'bold'),
            legend.background = element_rect(linetype = 1, size = 0.5, color = 1)) +
      labs(x = 'Edad', y = 'ASFR fx') +
      scale_color_manual(values = c('grey41', 'orangered', 'yellow', 'black'), name = 'Datos')
```

Ahora bien, para obtener una medida de la incertidumbre mencionada, se procedió a calcular los intervalos de credibilidad y la estimación de la mediana (percentil 0.5 de la estimación de la distribución predictiva posterior para cada edad).

Con el fin de observar cómo varía la incertidumbre con respecto a la estimación puntual, se procedió a computar el \textit{ECM} en cada combinación de  $\alpha$ y $\kappa$  seleccionando como candidatos de valores pertenecientes a la estimación de la distribución a posteriori aquellos que tienen error menor o igual al percentil que acumula un 10\%, 50\%, y 75\% de la probabilidad de la distribución del error respectivamente. En la figura 4 se presenta el gráfico con los resultados.


```{r datos}

edad <- 10:55 %>% data.table()
colnames(edad) <- "age"

# Loop para cargar datos de carpetas
for (i in 1:520){
      
  ruta <- paste0("Materiales/resultados/ini_c_2000/ne_10/N_520/param_set_",i+100)
      
  y_pred <- read_rds(here(ruta,"fx.Rdata")) %>% data.table()
      
  colnames(y_pred) <- c("age",paste0("fx_",i+100))
      
  setkey(y_pred,age)
      
  setkey(edad,age)
      
  edad <- edad[y_pred,nomatch=0]
}

quantiles <- apply(edad[,-1],1,function(y){
      int_inf <- quantile(y,0.025)
      int_sup <- quantile(y,0.975)
      mediana <- quantile(y,0.5)
      return(c(int_inf,int_sup,mediana))
}) 

datos <- data.table(age=edad$age,
                    int_inf=quantiles[1,],
                    int_sup=quantiles[2,],
                    mediana=quantiles[3,])

# Agregamos los valores observados
obs <- readr::read_csv(here::here("Materiales/datos/","asfr_hutterites.csv"))
datos$fx <- obs$fx
```


Gráfico de líneas de las \textit{ASFR}, valores observados, mediana
e intervalo de confianza al 95\%. Se observa que la amplitud de los intervalos de
confianza aumenta conforme se incrementa el valor de $\epsilon$ seleccionado y la
edad de la madre.

```{r, fig.cap='Gráfico de líneas de las ASFR, valores observados, mediana e intervalo de confianza al 95%. Se observa que la amplitud de los intervalos de confianza aumenta conforme se incrementa el valor de epsilon seleccionado y la edad de la madre.', fig.pos="H"}

datostot <- bind_rows(datos %>% mutate(tipo = 'Sin filtrar'), datos2 %>% mutate(tipo = 'Percentil 0.1'),
                      datos3 %>% mutate(tipo = 'Percentil 0.5'), datos4 %>% mutate(tipo = 'Percentil 0.75'))

names <- list(
  'Sin filtrar'="Sin filtrar",
  'Percentil 0.1'="Percentil 0.1",
  'Percentil 0.5'="Percentil 0.5",
  'Percentil 0.75' = "Percentil 0.75")

facet_labeller <- function(variable,value){
  return(names[value])
}


colors <- c("Simulado" = "red", "Observado" = "grey41")
datostot %>% ggplot(aes(x=age))+
      geom_line(aes(y=mediana, color="Simulado")) +
      geom_ribbon(aes(ymin=int_inf,ymax=int_sup),alpha=0.2, fill = 'red') + 
      geom_line(aes(y=fx, color="Observado"), linetype = 'dashed') +
      labs(x = 'Edad', y = 'fx (ASFR)', color = 'ASFR por edad') +
      scale_color_manual(values = colors) +
      theme(axis.title = element_text(face = 'bold'),
            legend.position = 'bottom',
            legend.background = element_rect(linetype = 1, size = 0.5, color = 1),
            strip.text = element_text(face="bold")) +
      facet_wrap(~tipo, labeller = facet_labeller)
```

# Conclusiones

Si bien el modelo \textit{Comfert} nos permite obtener estimaciones para las tasas de fecundidad por edad, el enfoque bayesiano implementado (\textit{ABC Bayes}) nos permite observar y cuantificar la incertidumbre subyacente en el fenómeno de estudio, pudiendo observar la existencia de aleatoriedad en las tasas de fecundidad por edad. Esto último en función de la parametrización seleccionada.

Si bien para valores elevados de $\epsilon$ el modelo parece lograr un ajuste satisfactorio en las edades avanzadas, se detecta un problema en todos los casos para edades tempranas. Una posible explicación está en que el modelo considera como parámetros la edad en la que decae la fecundidad y la tasa para dicha edad, sin considerar algún punto de inflexión para edades tempranas. Esto puede estar vinculado a los supuestos establecidos respecto a la edad de la unión (matrimonio), en particular a la modelización seleccionada para el tiempo de espera hasta el matrimonio.

Por otra parte, las estimaciones sobre la \textit{ASFR} dependen del valor de $\epsilon$ seleccionado. Para valores de $\epsilon$ pequeños (en particular percentil 10\%) existen valores observados que quedan por fuera del intervalo de credibilidad al 95\%.

De esta manera, el modelo implementado no solamente nos pérmite observar y cuantificar la aleatoriedad en las tasas de fecundidad por edad, sino también que la incertidumbre aumenta significativamente cuanto mayor es el nivel de tolerancia utilizado.

# Futuros trabajos

Para futuras investigaciones se considera de interés incorporar al modelo la salida de unidades por fallecimiento y los fenómenos asociados a las migraciones.

Adicionalmente, como extensión del modelo a poblaciones más avanzadas en la
transición demográfica incluir una parametrización que considere la aleatoriedad
proveniente de la utilización de métodos anticonceptivos y de la planificación o
no del embarazo. Es decir, poblaciones bajo un régimen de fecundidad regulada.

En lo que respecta a la metodología utilizada, existen por lo menos dos formas
de mejorar el enfoque utilizado.

En primer lugar, con respecto al elevado costo computacional inherente al modelo
uno de los algoritmos más utilizados para reducirlo es el algoritmo denominado
ABC regression adjustment (Beaumont et al., 2002). La idea principal
de dicho algoritmo es correr un ABC estándar y considerar un margen de error
amplio con el fin de ajustar la muestra obtenida mediante una regresión. 

En segundo lugar, la obtención de los candidatos para la distribución a posteriori
en función de una indicatriz implica una pérdida de información. Esto en el
sentido que no permite cuantificar la distancia relativa entre el punto observado
y simulado. Como posible alternativa se considera apropiado sustituir la función
indicatriz por una función kernel.

# Biblografía
 
- Overview of Approximate Bayesian Computation S. A. Sisson Y. Fan and M. A. Beaumonty February 28, 2018.
- A review of Approximate Bayesian Computation methods via density estimation: inference for simulator-models Clara Grazian and Yanan Fan, September 2019.
- R Core Team (2020). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.
- Demographic Models of the Reproductive Process:Past, Interlude, and Future. Daniel Ciganda, Nicolas Todd.
- Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686.
- Kirill Müller (2017). here: A Simpler Way to Find Your Files. R package version 0.1. https://CRAN.R-project.org/package=here.
- Matt Dowle and Arun Srinivasan (2020). data.table: Extension of `data.frame`. R package version 1.13.0. https://CRAN.R-project.org/package=data.table.





